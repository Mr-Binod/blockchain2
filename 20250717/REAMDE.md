# ERC 4337 EntryPoint

> 엔트리포인트의 이해가 중요하고
> 엔트리포인트를 이해해야 userOps의 구조가 이해가 된다.
> handleOps라는 메서드를 생성해서 유저가 보낸 스마트 계정의 작업을 처리해준다.

> 외부호출 (EOA -> 컨트랙트 혹은 EOA -> EOA), 내부호출(컨트랙트 -> 컨트랙트)

> 이더리움 송금 

### EntryPoint
> ERC4337의 핵심 요소 중에 하나
> 생성된 모든 스마트 지갑 즉 지갑 컨트랙트의 중개 역활
> 트랙잭션 요청를 보내기 시작하는 입구
> 스마트 지갑에 직접 요청은 하면 안된다.
> 스마트 지갑은 exeute를 실행 요청 받아서 처리를 한다.

유저 (userOps객체 생성) -> 번들러 (대납자가 가스비 지불) -> 엔트리 포인트 (검증 로직 호출 이후)-> 스마트 계정

> EntryPoint가 필요한 이유는 일반 사용자 EOA는 구조가 정의되어있는 외부 지갑이고 이더리움 네트워크에서 서명 검증 처리로직이 발생하고 가스비 지불 로직이 발생을 하기 때문에 스마트 지갑은 지갑의 개념을 바꿀수 있는 구조
이 구조를 유지하면서 지갑을 사용하기 위해서는 userOps라는 객체를 생성해서 지갑의 요청을 보내기 위한 검증 작업이 필요하다.

> 스마트 계정의 구조를 정의하기 위해서 규칙을 만들었다.
> userOps의 구조를 만들어서 스마트 계정에 대리호출을 요청하는 형태로 안전하게 설계
> 스마트 계정의 관리자 역활을 하는 중앙 관리자 역활 (검증과 대리실행)

1. handleOps
2. validateUserOp 서명검증
3. 이벤트 성공이나 실패 여부의 로그내용

### UserOperation
1. sender
2. nonce
3. initCode
4. callData
5. callGasLimit
6. verifictionGasLimit
7. preVerifiCationGas
8. maxFeePerGas
9. maxPrioityFeePerGas
10. paymasterAndData
11. signature

> 기존 트랜잭션(이더리움 네트워크)의 내용이 아닌 EntryPoint가 이해할수 있는 사용할수있는 구조를 정의한것.

#### sender
> 맞는 사용자인지를 확인하기 위한 주소 값
> 스마트 계정을 가지고 있는 사람이 맞는지
> EntryPoint가 누가 실행하는 작업인지 서명 검증 보내는 사람 => 스마트 계정

#### calldata
> userOps의 서명검증이 다 끝나면 실행시킬 delegate call 실행을 하기위한 바이트 코드 내용 스마트 계정에서 로직을 호출하기위한 바이트 코드 내용 핵심요소

#### useops의 구성 요소의 형태의 이유
> EntryPoint가 스마트 계정의 로직을 사용자 대신 호출을 해주어야하기 때문에 
> 서명 검증과 가스 수수료 지불로직 스마트계정 로직 호출을 하기위해서 필요한 작업 내용의 형태를 요구하는것.

#### userops 새로운 트랜잭션의 형태
> 상위 계층 즉 코드영역에서 이더리움 네트워크의 트랜잭션을 호출하기 전에
> 우리가 정의할수 있는 내용을 객체로 만들어서 서명검증 로직을 처리하는데 필요한 값 정의

1. userops 만들고 요청
2. 번들러에서 userops를 트랜잭션 풀로 관리 -> 여기서 트랜잭션풀은 블록체인 네트워크의 트랜잭션 풀과는 별개 아예 다른것.
3. entrypoint로 작업 내용 전달 트랜잭션 호출 대납의 조건 확인 
4. 수정할수없는 컨트랙트 블록에 기록되어있는 EVM에 저장되어 있는 컨트랙트 영역 즉 중앙관리자 entrypoint에서 서명검증을 한뒤에 로직 실행 

#### userOpearation 핵심 속성
> sender : 스마트 계정 주소
> nonce : 중복 방지 넘버 => 번들러 단에서 그리고 컨트랙트에 기록되는 상태변수
> initCode : 스마트 계정이 있는지 없는지 여부 0x면 스마트 계정을 생성해야한다.
> callData : 실제 실행할 로직 dalegate call 대리호출에서 실행할 로직
> gas : 등등등
> signature : 서명 정보 => 이더리움 네트워크에서 가스비 수수료 처리하는 사람의 서명이 아닌 스마트 계정 사용자를 신원 검증하기 위한 값. => 서명을 확장할수 있는 가능성이 있다.
> paymaster : 실제 스마트 계정의 핵심중 가스비 대납을 하는 계정(제안에서 옵션)

#### entryPoint 핵심 기능
> handleOps : userOperation[] 순서대로 배열의 작업 내용을 처리
> 검증에 필요한 로직이 포함


### 오늘 실습
1. 스마트 계정 소셜형식으로 생성
2. 스마트계정에 이더가 있고
3. 스마트 계정이 EOA 혹은 컨트랙트에 이더를 송금

> remixd -s . -u https://remix.ethereum.org